CREATE TABLE IF NOT EXISTS "roles" (
    "ID" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "NAME" NVARCHAR(100) NOT NULL UNIQUE
);

CREATE TABLE IF NOT EXISTS "teams" (
    "ID" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "NAME" NVARCHAR(100) NOT NULL UNIQUE
);

CREATE TABLE IF NOT EXISTS "users" (
    "ID" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "AZURE_ID" NVARCHAR(100) NOT NULL UNIQUE,
    "EMAIL" NVARCHAR(255) NOT NULL,
    "DISPLAY_NAME" NVARCHAR(255) NOT NULL,
    "PASSWORD_HASH" NVARCHAR(255),
    "ROLE_ID" BIGINT NOT NULL,
    "TEAM_ID" BIGINT NOT NULL,
    "ACTIVE" BIT NOT NULL DEFAULT 1,
    "CREATED_AT" DATETIME2 NOT NULL DEFAULT CURRENT_TIMESTAMP,
    CONSTRAINT fk_users_roles FOREIGN KEY ("ROLE_ID") REFERENCES "roles"("ID"),
    CONSTRAINT fk_users_teams FOREIGN KEY ("TEAM_ID") REFERENCES "teams"("ID")
);

CREATE TABLE IF NOT EXISTS "agents" (
    "ID" BIGINT GENERATED BY DEFAULT AS IDENTITY PRIMARY KEY,
    "USER_ID" BIGINT NOT NULL,
    "AGENT_CODE" NVARCHAR(64) NOT NULL,
    "TEAM_ROLE" NVARCHAR(128),
    CONSTRAINT fk_agents_users FOREIGN KEY ("USER_ID") REFERENCES "users"("ID"),
    CONSTRAINT uq_agents_code UNIQUE ("AGENT_CODE")
);

INSERT INTO "roles" ("NAME")
SELECT 'Agent'
WHERE NOT EXISTS (SELECT 1 FROM "roles" WHERE "NAME" = 'Agent');

INSERT INTO "teams" ("NAME")
SELECT 'Vendite'
WHERE NOT EXISTS (SELECT 1 FROM "teams" WHERE "NAME" = 'Vendite');
